<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Fitting a Mixture Model Using the Expectation-Maximization Algorithm in R</title>
  <meta name="description" content="In my previous post “Using Mixture Models for Clustering in R”, I covered the concept of mixture models and how one could use a gaussian mixture model (GMM),...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/syntax-style.css">
  <link rel="stylesheet" href="/css/site.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="canonical" href="http://localhost:4000/2016/01/03/gmm-em.html">
  <link rel="alternate" type="application/rss+xml" title="Wen-Ting Wang's Blog" href="http://localhost:4000/feed.xml" />

  <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script type="text/javascript" src="/js/jquery-1.11.3.min.js"></script>
  <script type="text/javascript" src="/js/jq_mathjax_parse.js"></script>
  <script type="text/javascript" src="/js/jquery.toc.min.js"></script>

  
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Wen-Ting Wang's Blog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
        
          
        
          
        
          
						<a class="page-link" href="/about/">About Me</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
						<a class="page-link" href="/resources/">Resources</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <a class="page-link" href="/tags/bioinfo/">Bioinformatics</a>
        <a class="page-link" href="/tags/cancer/">Cancer</a>
        <a class="page-link" href="/tags/R/">R</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        


<div class="post">

  <header class="post-header">
    <h1 class="post-title">Fitting a Mixture Model Using the Expectation-Maximization Algorithm in R</h1>
    <p class="post-meta">Jan 3, 2016</p>
    <p id="post-meta"><i class="fa fa-tags"></i>: <a href="/tags/R/">R</a>, <a href="/tags/mixmodels/">Mixture Models</a>, <a href="/tags/EM/">Expectation-Maximization</a></p>
  </header>

  <article class="post-content">
    <p>In my previous post <a href="/2015/10/13/mixture-model.html">“Using Mixture Models for Clustering in R”</a>, I covered the concept of mixture models and how one could use a gaussian mixture model (GMM), one type of mixure model, for clustering. If you are like me, not knowing what is happening “under the hood” may bug you. What is actually happening when I run the <code class="highlighter-rouge">normalmixEM</code> function from mixtools?  How does it know where to “put” the components?  In this post, I will cover how we can implement your own GMM in R.</p>

<p>We will first start this post by discussing a bit about parameter estimation. Then we will introduce the expectation-maximization (EM) algorithm and how it can be used in parameter estimation. Then we will walk through how to implement the EM algorithm.</p>

<p><strong>Table of Contents</strong></p>

<ul data-toc="body" data-toc-headings="h2,h3"></ul>

<h2 id="parameter-estimation-in-the-complete-data-scenario">Parameter Estimation in the “Complete Data” Scenario</h2>

<p>Let’s start with the scenario where you are given the following 1-dimensional data with the colors representing the “source” they are from:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="s2">"ggplot2"</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="s2">"dplyr"</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="s2">"reshape2"</span><span class="p">)</span><span class="w">

</span><span class="n">options</span><span class="p">(</span><span class="n">scipen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">999</span><span class="p">)</span><span class="w">
</span><span class="n">set.seed</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="w">

</span><span class="n">comp1.vals</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_frame</span><span class="p">(</span><span class="n">comp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"A"</span><span class="p">,</span><span class="w"> 
                         </span><span class="n">vals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rnorm</span><span class="p">(</span><span class="m">50</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">))</span><span class="w">
</span><span class="n">comp2.vals</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_frame</span><span class="p">(</span><span class="n">comp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"B"</span><span class="p">,</span><span class="w"> 
                         </span><span class="n">vals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rnorm</span><span class="p">(</span><span class="m">50</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">))</span><span class="w">

</span><span class="n">vals.df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">bind_rows</span><span class="p">(</span><span class="n">comp1.vals</span><span class="p">,</span><span class="w"> </span><span class="n">comp2.vals</span><span class="p">)</span><span class="w">

</span><span class="n">vals.df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vals</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"A"</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">comp</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">(</span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.4</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_color_discrete</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Source of Data"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">xlab</span><span class="p">(</span><span class="s2">"Values"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme</span><span class="p">(</span><span class="n">axis.ticks.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w">
        </span><span class="n">axis.text.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w">
        </span><span class="n">axis.title.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w">
        </span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"top"</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<p><img src="http://localhost:4000/assets/gmm-em/parameter_est_complete_data-1.svg" alt="plot of chunk parameter_est_complete_data" /></p>

<p>Let’s say you believe that the data sources are actually a gaussian distribution. Then with these values and knowledge of their data source, how could you estimate the parameters of the gaussian distributions (<span class="inlinecode">$\mathcal{N}(X|\mu,\sigma$</span>)? In other words, what parameters most likely gave rise to the data we are observing.</p>

<p>We can use <a href="https://en.wikipedia.org/wiki/Normal_distribution#Estimation_of_parameters">maximum likelihood estimation</a> (MLE) to estimate the mean and standard deviation:</p>

<ul>
  <li><span class="inlinecode">$\mu_{k} = \frac{\sum_{i}^{N_{k}}x_{i,k}}{N_{k}}$</span></li>
  <li><span class="inlinecode">$\sigma_{k} = \frac{\sum_{i}^{N_{k}}(x_{i,k} - \mu_{k})^2}{N_{k}}$</span></li>
</ul>

<p>Let’s give this a try and see what values we get:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">vals.df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">summarize</span><span class="p">(</span><span class="n">mean_vals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">vals</span><span class="p">),</span><span class="w">
            </span><span class="n">sd_vals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sd</span><span class="p">(</span><span class="n">vals</span><span class="p">))</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## # A tibble: 2 × 3
##    comp mean_vals  sd_vals
##   &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1     A  1.050224 0.415697
## 2     B  1.558663 0.484414
</code></pre>
</div>

<p>This is very close to the true parameters of the gaussian which were mean and standard deviation of (1, 0.5), (1.5, 0.5) for the respective gaussians (NOTE: the more data we sample, the closer we get to the true parameters).</p>

<h2 id="parameter-estimation-in-the-incomplete-data-scenario">Parameter Estimation in the “Incomplete Data” Scenario</h2>

<p>Now let us consider the following scenario where you have the same data but you don’t know the source now.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">vals.df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vals</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">(</span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.4</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">xlab</span><span class="p">(</span><span class="s2">"Values"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme</span><span class="p">(</span><span class="n">axis.ticks.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w">
        </span><span class="n">axis.text.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w">
        </span><span class="n">axis.title.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">())</span><span class="w">
</span></code></pre>
</div>

<p><img src="http://localhost:4000/assets/gmm-em/parameter_est_incomplete_data-1.svg" alt="plot of chunk parameter_est_incomplete_data" /></p>

<p>Without the labels on the data (often called latent variables) indicating their source, we are hopeless in applying MLE. But if we somehow find a way to “complete” the data (i.e. find the labels for each data point), then we can go back to using MLE. One way around this could be to:</p>

<ol>
  <li>Set some initial parameter estimates on your gaussians.</li>
  <li>Assign (label) the data to one of the gaussians based on which one most likely generated the data.</li>
  <li>Treat the labels as being correct and then use MLE to re-estimate the parameters for the different gaussians.</li>
  <li>Repeat steps 2 and 3 until there is convergence.</li>
</ol>

<p>This iterative approach is the basis for something called the expectation-maximization (EM) algorithm. The main difference is rather than assigning the data to one of the possible gaussians, EM considers the possibilities of the data belonging to all of the possible gaussians. This is analogous to the concept of “hard” and “soft” labeling that I mentioned in my previous post <a href="/2015/10/13/mixture-model.html">“Using Mixture Models for Clustering in R”</a>. Working in a probablistic framework allows us to assign probabilities (responsibilities) of data belonging to a gaussian so that we don’t have to “commit” the data to any one gaussian.</p>

<p>The best way to remember what EM is used for is as follows:</p>

<blockquote>
  <p>The expectation maximization algorithm is a natural generalization of maximum likelihood estimation to the incomplete data case. – Chuong B Do &amp; Serafim Batzoglou. What is the expectation maximization algorithm? Nature Biotechnology. 2008.</p>
</blockquote>

<p>In this post, we will use the EM algorithm to fit our GMM.</p>

<h2 id="fitting-a-gmm-using-expectation-maximization">Fitting a GMM using Expectation Maximization</h2>

<p>The EM algorithm consists of 3 major steps:</p>

<ol>
  <li>Initialization</li>
  <li>Expectation (E-step)</li>
  <li>Maximization (M-step)</li>
</ol>

<p>Steps 2 and 3 are repeated until convergence. We will cover each of these steps and how convergence is reached below. But first we must understand how to mathematically represent a GMM:</p>

<div>
$$P(X|\mu,\sigma,\alpha) = \sum_{k=1}^{K}\alpha_k\mathcal{N}(X|\mu_{k},\sigma_{k}^{2})$$
</div>

<ul>
  <li>X = Dataset of n elements (<span class="inlinecode">$x_{1}, …, x_{n}$</span>).</li>
  <li><span class="inlinecode">$\alpha_{k}$</span> = Mixing weight of the kth component. <span class="inlinecode">$\sum_{k=1}^{K}\alpha_{k} = 1$</span>.</li>
  <li><span class="inlinecode">$\mathcal{N}(x|\mu_{k},\sigma_{k})$</span> = <a href="https://en.wikipedia.org/wiki/Normal_distribution">Gaussian probability density function (pdf)</a> of the kth component defined by the parameters <span class="inlinecode">$\mu_{k}$</span> and <span class="inlinecode">$\sigma_{k}$</span>.</li>
  <li><span class="inlinecode">$\mu_{k}$</span> = Mean of the kth component.</li>
  <li><span class="inlinecode">$\sigma_{k}^{2}$</span> = Variance of the kth component.</li>
</ul>

<p>So for a two component GMM, we would mathematically represent this as:</p>

<div>
$$P(X|\mu,\sigma,\alpha) = \alpha_1\mathcal{N}(X|\mu_{1},\sigma_{1}^{2}) + \alpha_2\mathcal{N}(X|\mu_{2},\sigma_{2}^{2})$$
</div>

<p>In case you were wondering what the <span class="inlinecode">$P(X|\mu,\sigma,\alpha)$</span> means, don’t worry about that for now. We will explain exactly what this means later on in the post.</p>

<h3 id="initialization-determining-the-initial-gmm-parameters">Initialization: Determining the Initial GMM Parameters</h3>

<p>When it comes to initialization of a GMM, we are asking the fundamental question of <strong>what model parameters do we first assign?</strong> This can be done in different ways, but for GMMs it’s very common to first run k-means on your data to get some hard-labels on the data. With these hard-labels, we can use MLE to estimate the component parameters for our initialization (remember MLE works in the “Complete Data” scenario):</p>

<ul>
  <li><span class="inlinecode">$\mu_{k} = \frac{\sum_{i}^{N_{k}}x_{i,k}}{N_{k}}$</span></li>
  <li><span class="inlinecode">$\sigma_{k} = \frac{\sum_{i}^{N_{k}}(x_{i,k} - \mu_{k})^2}{N_{k}}$</span></li>
  <li><span class="inlinecode">$\alpha_{k} = \frac{N_{k}}{N}$</span></li>
</ul>

<p>Where <span class="inlinecode">$N_{k}$</span> indicates the number of data points in the kth component. Let’s try that here:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">wait</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">faithful</span><span class="o">$</span><span class="n">waiting</span><span class="w">

</span><span class="n">wait.kmeans</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">kmeans</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">
</span><span class="n">wait.kmeans.cluster</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">wait.kmeans</span><span class="o">$</span><span class="n">cluster</span><span class="w">

</span><span class="n">wait.df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_frame</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wait</span><span class="p">,</span><span class="w"> </span><span class="n">cluster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wait.kmeans.cluster</span><span class="p">)</span><span class="w">

</span><span class="n">wait.df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row_number</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">cluster</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ylab</span><span class="p">(</span><span class="s2">"Values"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ylab</span><span class="p">(</span><span class="s2">"Data Point Number"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_color_discrete</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Cluster"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"K-means Clustering"</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<p><img src="http://localhost:4000/assets/gmm-em/kmeans_init-1.svg" alt="plot of chunk kmeans_init" /></p>

<p>Since we specified 2 clusters, k-means nicely splits the data into 2 clusters with means and standard deviation as follows:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">wait.summary.df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">wait.df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">summarize</span><span class="p">(</span><span class="n">mu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="n">std</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sd</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">())</span><span class="w">

</span><span class="n">wait.summary.df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span><span class="w"> </span><span class="n">mu</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## # A tibble: 2 × 3
##   cluster       mu      std
##     &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;
## 1       1 54.75000 5.895341
## 2       2 80.28488 5.627335
</code></pre>
</div>

<p>We can also generate the initial mixing weights as follows:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">wait.summary.df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">wait.summary.df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">size</span><span class="p">))</span><span class="w">

</span><span class="n">wait.summary.df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## # A tibble: 2 × 3
##   cluster  size     alpha
##     &lt;int&gt; &lt;int&gt;     &lt;dbl&gt;
## 1       1   100 0.3676471
## 2       2   172 0.6323529
</code></pre>
</div>

<h3 id="expectation-calculating-the-soft-labels-of-each-data-point-e-step">Expectation: Calculating the “Soft Labels” of Each Data Point (E-step)</h3>

<p>Now that we have the initial parameters of our GMM, we now have to determine what is the probability (soft label; responsibility) that the data point (<span class="inlinecode">$x_{i}$</span>) belongs to component (<span class="inlinecode">$k_{j}$</span>)? This is considered the expectation step (E-step) of MLE where we are calculating the “expectation values” of the soft labels for each data point.</p>

<p>Mathematically, the question can be posed like this <span class="inlinecode">$P(x_{i} \in k_{j} | x_{i})$</span>. How do we actually solve this equation? To help us, we can apply <a href="https://en.wikipedia.org/wiki/Bayes%27_rule">Bayes’ rule</a> here:</p>

<div>
$$P(x_{i} \in k_{j} | x_{i}) = \frac{P(x_{i} | x_{i} \in k_{j})P(k_{j})}{P(x_{i})}$$
</div>

<p>The parts of this equation are related to the GMM equation above as follows:</p>

<ul>
  <li><span class="inlinecode">$P(x_{i} | x_{i} \in k_{j}) = \mathcal{N}(x_{i}|\mu_{k_{j}},\sigma_{k_{j}})$</span></li>
  <li><span class="inlinecode">$P(k_{j}) = \alpha_{k_{j}}$</span></li>
  <li><span class="inlinecode">$P(x_{i}) = \sum_{k=1}^{K}\alpha_k\mathcal{N}(x_{i}|\mu_{k},\sigma_{k})$</span></li>
</ul>

<p>What we are interested in is <span class="inlinecode">$P(x_{i} \in k_{j} | x_{i})$</span> which is called the posterior probability. Knowing these equations, we can easily calculate this. For instance, what is the posterior probability of x = 66 belong to the first component? We can first calculate the top part of the equation like this in R:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">comp1.prod</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> 
  </span><span class="n">dnorm</span><span class="p">(</span><span class="m">66</span><span class="p">,</span><span class="w"> </span><span class="n">wait.summary.df</span><span class="o">$</span><span class="n">mu</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="n">wait.summary.df</span><span class="o">$</span><span class="n">std</span><span class="p">[</span><span class="m">1</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w">
  </span><span class="n">wait.summary.df</span><span class="o">$</span><span class="n">alpha</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w">
</span></code></pre>
</div>

<p>Here we are using the <code class="highlighter-rouge">dnrom</code> function from R to make use of the gaussian pdf. To calculate the bottom part of the equation, we actually need to calculate this value for both components and sum them up:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">comp2.prod</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> 
  </span><span class="n">dnorm</span><span class="p">(</span><span class="m">66</span><span class="p">,</span><span class="w"> </span><span class="n">wait.summary.df</span><span class="o">$</span><span class="n">mu</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="n">wait.summary.df</span><span class="o">$</span><span class="n">std</span><span class="p">[</span><span class="m">2</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w">
  </span><span class="n">wait.summary.df</span><span class="o">$</span><span class="n">alpha</span><span class="p">[</span><span class="m">2</span><span class="p">]</span><span class="w">

</span><span class="n">normalizer</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">comp1.prod</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">comp2.prod</span><span class="w">
</span></code></pre>
</div>

<p>Now that we have all the components of the equation, let’s plug and solve this:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">comp1.prod</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">normalizer</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## [1] 0.6926023
</code></pre>
</div>

<p>We can easily calculate this for every data point as follows:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">comp1.prod</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dnorm</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wait</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wait.summary.df</span><span class="o">$</span><span class="n">mu</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="w"> 
                    </span><span class="n">sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wait.summary.df</span><span class="o">$</span><span class="n">std</span><span class="p">[</span><span class="m">1</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">wait.summary.df</span><span class="o">$</span><span class="n">alpha</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w">

</span><span class="n">comp2.prod</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dnorm</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wait</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wait.summary.df</span><span class="o">$</span><span class="n">mu</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w"> 
                    </span><span class="n">sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wait.summary.df</span><span class="o">$</span><span class="n">std</span><span class="p">[</span><span class="m">2</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">wait.summary.df</span><span class="o">$</span><span class="n">alpha</span><span class="p">[</span><span class="m">2</span><span class="p">]</span><span class="w">

</span><span class="n">normalizer</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">comp1.prod</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">comp2.prod</span><span class="w">

</span><span class="n">comp1.post</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">comp1.prod</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">normalizer</span><span class="w">
</span><span class="n">comp2.post</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">comp2.prod</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">normalizer</span><span class="w">
</span></code></pre>
</div>

<h3 id="maximization-re-estimate-the-component-parameters-m-step">Maximization: Re-estimate the Component Parameters (M-step)</h3>

<p>Now that we have posterior probabilites (i.e. soft labels), we can re-estimate our component parameters. We simply have to make a little adjustment to the MLE equations that we specified early. Specifically, the <span class="inlinecode">$N_{k}$</span> (remember there are no hard labels) is replaced with the posterior probability <span class="inlinecode">$P(x_{i} \in k_{j} | x_{i})$</span> in each equation.</p>

<ul>
  <li><span class="inlinecode">$\mu_{k} = \frac{\sum_{i}^{N}P(x_{i} \in k_{j} | x_{i})x_{i}}{\sum_{i}^{N}P(x_{i} \in k_{j} | x_{i})}$</span></li>
  <li><span class="inlinecode">$\sigma_{k} = \frac{\sum_{i}^{N}P(x_{i} \in k_{j} | x_{i})(x_{i} - \mu_{k})^2}{\sum_{i}^{N}P(x_{i} \in k_{j} | x_{i})}$</span></li>
  <li><span class="inlinecode">$\alpha_{k} = \frac{\sum_{i}^{N}P(x_{i} \in k_{j} | x_{i})}{N}$</span></li>
</ul>

<p>With these equations we can now plug in our values and calculate the components parameters using our example from above:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">comp1.n</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">comp1.post</span><span class="p">)</span><span class="w">
</span><span class="n">comp2.n</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">comp2.post</span><span class="p">)</span><span class="w">

</span><span class="n">comp1.mu</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="o">/</span><span class="n">comp1.n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">comp1.post</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">wait</span><span class="p">)</span><span class="w">
</span><span class="n">comp2.mu</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="o">/</span><span class="n">comp2.n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">comp2.post</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">wait</span><span class="p">)</span><span class="w">

</span><span class="n">comp1.var</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">comp1.post</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">wait</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">comp1.mu</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">1</span><span class="o">/</span><span class="n">comp1.n</span><span class="w">
</span><span class="n">comp2.var</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">comp2.post</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">wait</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">comp2.mu</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">1</span><span class="o">/</span><span class="n">comp2.n</span><span class="w">

</span><span class="n">comp1.alpha</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">comp1.n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span><span class="w">
</span><span class="n">comp2.alpha</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">comp2.n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span><span class="w">

</span><span class="n">comp.params.df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">comp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"comp1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"comp2"</span><span class="p">),</span><span class="w">
                             </span><span class="n">comp.mu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">comp1.mu</span><span class="p">,</span><span class="w"> </span><span class="n">comp2.mu</span><span class="p">),</span><span class="w">
                             </span><span class="n">comp.var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">comp1.var</span><span class="p">,</span><span class="w"> </span><span class="n">comp2.var</span><span class="p">),</span><span class="w">
                             </span><span class="n">comp.alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">comp1.alpha</span><span class="p">,</span><span class="w"> </span><span class="n">comp2.alpha</span><span class="p">),</span><span class="w">
                             </span><span class="n">comp.cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"self"</span><span class="p">,</span><span class="w"> </span><span class="s2">"self"</span><span class="p">))</span><span class="w">
</span></code></pre>
</div>

<h3 id="checking-for-convergence">Checking for Convergence</h3>

<p>As mentioned above, we repeat the expectation and maximization step until we reach “convergence”. But what exactly is convergence? The concept of convergence means that we have a change that is minimal enough for us to consider it to neligible and stop running EM. So the question becomes what is the change we are measuring?</p>

<p>Well since we are fitting trying to fit a GMM to our data, then inituitvely <strong>we should have something that measures the fit of our GMM!</strong> This is actually the final piece of the puzzle. Formally speaking, what we are looking for is called a <a href="https://en.wikipedia.org/wiki/Loss_function">cost function</a> (aka. objective function, loss function).</p>

<p>As it turns out, we’ve already seen the cost function that we need (See “Fitting a GMM using Expectation Maximization”):</p>

<div>
$$ P(X|\mu,\sigma,\alpha) = \sum_{k=1}^{K}\alpha_k\mathcal{N}(X|\mu_{k},\sigma_{k}^{2}) $$
</div>

<p>This called the likelihood (see this <a href="http://alexanderetz.com/2015/04/15/understanding-bayes-a-look-at-the-likelihood/">post for a good explanation on what a likelihood is</a>) and is essentially the fit of your model. Really what we are asking in layman terms is given these model parameters (<span class="inlinecode">$\mu,\sigma,\alpha$</span>), what is the probability that our data X was generated by them. A slight modification of this is the log likelihood which equates to:</p>

<div>
$$ \ln P(X|\mu,\sigma,\alpha) = \sum_{n=1}^{N}\ln \sum_{k=1}^{K}\alpha_k\mathcal{N}(x_{n}|\mu_{k},\sigma_{k}^{2}) $$
</div>

<p>The reason why we do this is because if we simply calculate the likelihood we would end up dealing with very small values which can be problematic. So we take the natural logarithm of the likelihood to circumvent this.</p>

<blockquote>
  <p>The larger the log likelihood = Better the model parameters fit the data</p>
</blockquote>

<p>For instance, the log likelihood of our first EM step:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1"># Already calculate component responsibilities for each data point from above
</span><span class="n">sum.of.comps</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">comp1.prod</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">comp2.prod</span><span class="w">
</span><span class="n">sum.of.comps.ln</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="n">sum.of.comps</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">exp</span><span class="p">(</span><span class="m">1</span><span class="p">))</span><span class="w">
</span><span class="nf">sum</span><span class="p">(</span><span class="n">sum.of.comps.ln</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## [1] -1034.246
</code></pre>
</div>

<p>So to test for convergency, we can calculate the log likelihood at the end of each EM step (i.e. model fit with these parameters) and then test whether it has changed “significantly” (defined by the user) from the last EM step. If it has, then we repeat another step of EM. If not, then we consider that EM has converged and then these are our final parameters.</p>

<h3 id="putting-it-all-together">Putting it All Together</h3>

<p>Now that we have all these pieces of information together, let’s put it altogether:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="cd">#' Expectation Step of the EM Algorithm
#'
#' Calculate the posterior probabilities (soft labels) that each component
#' has to each data point.
#'
#' @param sd.vector Vector containing the standard deviations of each component
#' @param sd.vector Vector containing the mean of each component
#' @param alpha.vector Vector containing the mixing weights  of each component
#' @return Named list containing the loglik and posterior.df
</span><span class="n">e_step</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">mu.vector</span><span class="p">,</span><span class="w"> </span><span class="n">sd.vector</span><span class="p">,</span><span class="w"> </span><span class="n">alpha.vector</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">comp1.prod</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dnorm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">mu.vector</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="n">sd.vector</span><span class="p">[</span><span class="m">1</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">alpha.vector</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w">
  </span><span class="n">comp2.prod</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dnorm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">mu.vector</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="n">sd.vector</span><span class="p">[</span><span class="m">2</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">alpha.vector</span><span class="p">[</span><span class="m">2</span><span class="p">]</span><span class="w">
  </span><span class="n">sum.of.comps</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">comp1.prod</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">comp2.prod</span><span class="w">
  </span><span class="n">comp1.post</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">comp1.prod</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">sum.of.comps</span><span class="w">
  </span><span class="n">comp2.post</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">comp2.prod</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">sum.of.comps</span><span class="w">

  </span><span class="n">sum.of.comps.ln</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="n">sum.of.comps</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">exp</span><span class="p">(</span><span class="m">1</span><span class="p">))</span><span class="w">
  </span><span class="n">sum.of.comps.ln.sum</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">sum.of.comps.ln</span><span class="p">)</span><span class="w">

  </span><span class="nf">list</span><span class="p">(</span><span class="s2">"loglik"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum.of.comps.ln.sum</span><span class="p">,</span><span class="w">
       </span><span class="s2">"posterior.df"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbind</span><span class="p">(</span><span class="n">comp1.post</span><span class="p">,</span><span class="w"> </span><span class="n">comp2.post</span><span class="p">))</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="cd">#' Maximization Step of the EM Algorithm
#'
#' Update the Component Parameters
#'
#' @param x Input data.
#' @param posterior.df Posterior probability data.frame.
#' @return Named list containing the mean (mu), variance (var), and mixing
#'   weights (alpha) for each component.
</span><span class="n">m_step</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">posterior.df</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">comp1.n</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">posterior.df</span><span class="p">[,</span><span class="w"> </span><span class="m">1</span><span class="p">])</span><span class="w">
  </span><span class="n">comp2.n</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">posterior.df</span><span class="p">[,</span><span class="w"> </span><span class="m">2</span><span class="p">])</span><span class="w">

  </span><span class="n">comp1.mu</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="o">/</span><span class="n">comp1.n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">posterior.df</span><span class="p">[,</span><span class="w"> </span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w">
  </span><span class="n">comp2.mu</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="o">/</span><span class="n">comp2.n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">posterior.df</span><span class="p">[,</span><span class="w"> </span><span class="m">2</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w">

  </span><span class="n">comp1.var</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">posterior.df</span><span class="p">[,</span><span class="w"> </span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">comp1.mu</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">1</span><span class="o">/</span><span class="n">comp1.n</span><span class="w">
  </span><span class="n">comp2.var</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">posterior.df</span><span class="p">[,</span><span class="w"> </span><span class="m">2</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">comp2.mu</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">1</span><span class="o">/</span><span class="n">comp2.n</span><span class="w">

  </span><span class="n">comp1.alpha</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">comp1.n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w">
  </span><span class="n">comp2.alpha</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">comp2.n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w">

  </span><span class="nf">list</span><span class="p">(</span><span class="s2">"mu"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">comp1.mu</span><span class="p">,</span><span class="w"> </span><span class="n">comp2.mu</span><span class="p">),</span><span class="w">
       </span><span class="s2">"var"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">comp1.var</span><span class="p">,</span><span class="w"> </span><span class="n">comp2.var</span><span class="p">),</span><span class="w">
       </span><span class="s2">"alpha"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">comp1.alpha</span><span class="p">,</span><span class="w"> </span><span class="n">comp2.alpha</span><span class="p">))</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>Now we just need to write a loop to go between the functions for each EM step. Each iteration will consist of us first calling the <code class="highlighter-rouge">e_step</code> function and then calling the <code class="highlighter-rouge">m_step</code> function (if needed). We will run this for 50 iterations or when the log likelihood difference between two iteration is less than <code class="highlighter-rouge">1e-6</code> (whichever comes first):</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">50</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="c1"># Initialization
</span><span class="w">    </span><span class="n">e.step</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">e_step</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span><span class="w"> </span><span class="n">wait.summary.df</span><span class="p">[[</span><span class="s2">"mu"</span><span class="p">]],</span><span class="w"> </span><span class="n">wait.summary.df</span><span class="p">[[</span><span class="s2">"std"</span><span class="p">]],</span><span class="w">
                     </span><span class="n">wait.summary.df</span><span class="p">[[</span><span class="s2">"alpha"</span><span class="p">]])</span><span class="w">
    </span><span class="n">m.step</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">m_step</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span><span class="w"> </span><span class="n">e.step</span><span class="p">[[</span><span class="s2">"posterior.df"</span><span class="p">]])</span><span class="w">
    </span><span class="n">cur.loglik</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">e.step</span><span class="p">[[</span><span class="s2">"loglik"</span><span class="p">]]</span><span class="w">
    </span><span class="n">loglik.vector</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">e.step</span><span class="p">[[</span><span class="s2">"loglik"</span><span class="p">]]</span><span class="w">
  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="c1"># Repeat E and M steps till convergence
</span><span class="w">    </span><span class="n">e.step</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">e_step</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span><span class="w"> </span><span class="n">m.step</span><span class="p">[[</span><span class="s2">"mu"</span><span class="p">]],</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">(</span><span class="n">m.step</span><span class="p">[[</span><span class="s2">"var"</span><span class="p">]]),</span><span class="w"> 
                     </span><span class="n">m.step</span><span class="p">[[</span><span class="s2">"alpha"</span><span class="p">]])</span><span class="w">
    </span><span class="n">m.step</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">m_step</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span><span class="w"> </span><span class="n">e.step</span><span class="p">[[</span><span class="s2">"posterior.df"</span><span class="p">]])</span><span class="w">
    </span><span class="n">loglik.vector</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">loglik.vector</span><span class="p">,</span><span class="w"> </span><span class="n">e.step</span><span class="p">[[</span><span class="s2">"loglik"</span><span class="p">]])</span><span class="w">

    </span><span class="n">loglik.diff</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">abs</span><span class="p">((</span><span class="n">cur.loglik</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">e.step</span><span class="p">[[</span><span class="s2">"loglik"</span><span class="p">]]))</span><span class="w">
    </span><span class="k">if</span><span class="p">(</span><span class="n">loglik.diff</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">1e-6</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="k">break</span><span class="w">
    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="n">cur.loglik</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">e.step</span><span class="p">[[</span><span class="s2">"loglik"</span><span class="p">]]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="n">loglik.vector</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>##  [1] -1034.246 -1034.047 -1034.020 -1034.010 -1034.005 -1034.003 -1034.002
##  [8] -1034.002 -1034.002 -1034.002 -1034.002 -1034.002 -1034.002 -1034.002
## [15] -1034.002 -1034.002
</code></pre>
</div>

<p>As you can see, we actual stopped running EM after 16 iterations because the log likelihood didn’t change much (specifically, the difference between the 15th and 16th iteration was &lt; 1e6). We classify this as convergence of the algorithm and this represents our final fit.</p>

<p>So our final component parameters are as follows:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">m.step</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## $mu
## [1] 54.61510 80.09122
## 
## $var
## [1] 34.47368 34.42849
## 
## $alpha
## [1] 0.3608934 0.6391066
</code></pre>
</div>

<p>Which produces the following mixture model:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="cd">#' Plot a Mixture Component
#' 
#' @param x Input ata.
#' @param mu Mean of component.
#' @param sigma Standard of component.
#' @param lam Mixture weight of component.
</span><span class="n">plot_mix_comps</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">mu</span><span class="p">,</span><span class="w"> </span><span class="n">sigma</span><span class="p">,</span><span class="w"> </span><span class="n">lam</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">lam</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dnorm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">mu</span><span class="p">,</span><span class="w"> </span><span class="n">sigma</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">data.frame</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wait</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_histogram</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">..density..</span><span class="p">),</span><span class="w"> </span><span class="n">binwidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"black"</span><span class="p">,</span><span class="w"> 
                 </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"white"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">stat_function</span><span class="p">(</span><span class="n">geom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"line"</span><span class="p">,</span><span class="w"> </span><span class="n">fun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plot_mix_comps</span><span class="p">,</span><span class="w">
                </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">m.step</span><span class="o">$</span><span class="n">mu</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">(</span><span class="n">m.step</span><span class="o">$</span><span class="n">var</span><span class="p">[</span><span class="m">1</span><span class="p">]),</span><span class="w"> 
                           </span><span class="n">lam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m.step</span><span class="o">$</span><span class="n">alpha</span><span class="p">[</span><span class="m">1</span><span class="p">]),</span><span class="w">
                </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"red"</span><span class="p">,</span><span class="w"> </span><span class="n">lwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">stat_function</span><span class="p">(</span><span class="n">geom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"line"</span><span class="p">,</span><span class="w"> </span><span class="n">fun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plot_mix_comps</span><span class="p">,</span><span class="w">
                </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">m.step</span><span class="o">$</span><span class="n">mu</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">(</span><span class="n">m.step</span><span class="o">$</span><span class="n">var</span><span class="p">[</span><span class="m">2</span><span class="p">]),</span><span class="w"> 
                           </span><span class="n">lam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m.step</span><span class="o">$</span><span class="n">alpha</span><span class="p">[</span><span class="m">2</span><span class="p">]),</span><span class="w">
                </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"blue"</span><span class="p">,</span><span class="w"> </span><span class="n">lwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ylab</span><span class="p">(</span><span class="s2">"Density"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">xlab</span><span class="p">(</span><span class="s2">"Values"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Final GMM Fit"</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<p><img src="http://localhost:4000/assets/gmm-em/final_gmm-1.svg" alt="plot of chunk final_gmm" /></p>

<h2 id="summary">Summary</h2>

<p>In this post, I have demonstrated how to implement your own mixture model where each component is a gaussian. The logic can easily be extended to other types of mixture models by simply substituting the components for the appropriate statistical distribution needed. We used the well known EM algorithm to allow us to use MLE in the incomplete data scenario.</p>

<p>I hope this post gives you some insight into the inner workings of how to fit a gaussian mixture model!</p>

<ul>
  <li>March 13, 2017 - Fixed maximization equations. Used the likelihood instead of posterior equation by accident. Thanks <a href="https://disqus.com/by/koustuvsinha/">Koustuv Sinha</a> for pointing this out!</li>
</ul>

<h2 id="r-session">R Session</h2>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">devtools</span><span class="o">::</span><span class="n">session_info</span><span class="p">()</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## Session info --------------------------------------------------------------
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>##  setting  value                       
##  version  R version 3.3.2 (2016-10-31)
##  system   x86_64, darwin11.4.2        
##  ui       unknown                     
##  language (EN)                        
##  collate  en_CA.UTF-8                 
##  tz       America/Vancouver           
##  date     2017-03-13
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## Packages ------------------------------------------------------------------
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>##  package    * version date       source        
##  argparse   * 1.0.4   2016-10-28 CRAN (R 3.3.2)
##  assertthat   0.1     2013-12-06 CRAN (R 3.3.2)
##  colorspace   1.3-1   2016-11-18 CRAN (R 3.3.2)
##  DBI          0.5-1   2016-09-10 CRAN (R 3.3.2)
##  devtools     1.12.0  2016-12-05 CRAN (R 3.3.2)
##  digest       0.6.10  2016-08-02 CRAN (R 3.3.2)
##  dplyr      * 0.5.0   2016-06-24 CRAN (R 3.3.2)
##  evaluate     0.10    2016-10-11 CRAN (R 3.3.2)
##  findpython   1.0.1   2014-04-03 CRAN (R 3.3.2)
##  gdtools    * 0.1.3   2016-11-11 CRAN (R 3.3.2)
##  getopt       1.20.0  2013-08-30 CRAN (R 3.3.2)
##  ggplot2    * 2.2.0   2016-11-11 CRAN (R 3.3.2)
##  gtable       0.2.0   2016-02-26 CRAN (R 3.3.2)
##  highr        0.6     2016-05-09 CRAN (R 3.3.2)
##  knitr      * 1.15.1  2016-11-22 CRAN (R 3.3.2)
##  labeling     0.3     2014-08-23 CRAN (R 3.3.2)
##  lazyeval     0.2.0   2016-06-12 CRAN (R 3.3.2)
##  magrittr     1.5     2014-11-22 CRAN (R 3.3.2)
##  memoise      1.0.0   2016-01-29 CRAN (R 3.3.2)
##  munsell      0.4.3   2016-02-13 CRAN (R 3.3.2)
##  plyr         1.8.4   2016-06-08 CRAN (R 3.3.2)
##  proto      * 1.0.0   2016-10-29 CRAN (R 3.3.2)
##  R6           2.2.0   2016-10-05 CRAN (R 3.3.2)
##  Rcpp         0.12.8  2016-11-17 CRAN (R 3.3.2)
##  reshape2   * 1.4.2   2016-10-22 CRAN (R 3.3.2)
##  rjson        0.2.15  2014-11-03 CRAN (R 3.3.2)
##  scales       0.4.1   2016-11-09 CRAN (R 3.3.2)
##  stringi      1.1.2   2016-10-01 CRAN (R 3.3.2)
##  stringr      1.1.0   2016-08-19 CRAN (R 3.3.2)
##  svglite    * 1.2.0   2016-11-04 CRAN (R 3.3.2)
##  tibble       1.2     2016-08-26 CRAN (R 3.3.2)
##  withr        1.0.2   2016-06-20 CRAN (R 3.3.2)
</code></pre>
</div>

<h2 id="references">References</h2>

<ul>
  <li><a href="https://www.youtube.com/playlist?list=PLBv09BD7ez_4e9LtmK626Evn1ion6ynrt">Youtube Videos on Mixture Models</a></li>
  <li><a href="http://www.stat.cmu.edu/~cshalizi/uADA/12/lectures/ch20.pdf">Mixture Models</a></li>
  <li><a href="http://www.slideshare.net/petitegeek/expectation-maximization-and-gaussian-mixture-models">Expectation Maximization and Gaussian Mixture Models</a></li>
  <li><a href="http://www.nature.com/nbt/journal/v26/n8/full/nbt1406.html">Nature Computational Biology Primer - What is the expectation maximization algorithm?</a></li>
</ul>


    <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'tinyheero';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Wen-Ting Wang's Blog</li>
          <li>
             <i class="fa fa-envelope"></i>
             <a href="mailto:egpivo@gmail.com">egpivo@gmail.com</a>
          </li>
					<li>
						<a href="http://orcid.org">
							<img src="http://about.orcid.org/sites/default/files/images/orcid_16x16(1).gif" style="width: 15px; height: 15px; ">
						</a>
						<a href="http://orcid.org/0000-0002-7825-2692"><span class="usename">orcid.org/0000-0002-7825-2692</span></a>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
              <i class="fa fa-github"></i>
              <a href="https://github.com/egpivo"><span class="username">egpivo</span></a>
          </li>
          

          
          <li>
            <i class="fa fa-linkedin"></i>
            <a href="https://ca.linkedin.com/in/fongchunchan"><span class="username">fongchunchan</span></a>
          </li>
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Science is a means whereby learning is achieved.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
